<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ùïÆùñÜùñë¬≤ Multiplication Trainer</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      box-sizing: border-box;
      min-height: 100vh;
      background: transparent !important;
      font-family: 'Orbitron', 'Courier New', Courier, monospace; color: #fff;
      padding: 0; margin: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      position: relative; overflow-x: hidden;
    }
    #matrix-bg {
      position: fixed;
      z-index: 0;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      pointer-events: none;
      opacity: 1;
      transition: opacity .5s;
      background: #000;
    }
    .sidebar-nav,
    .sidebar-toggle,
    .hud,
    .main-container,
    #fireworksContainer {
      position: relative;
      z-index: 1;
    }
    .hud { width: 100vw; max-width: 100vw; background: linear-gradient(90deg, #111 30%, #222 80%);
      box-shadow: 0 4px 20px #000a, 0 0 2px #0f0; display: flex; align-items: center; justify-content: space-around;
      font-size: 1.1rem; padding: 10px 0 8px 0; letter-spacing: 1.5px; user-select: none; gap: 7px;
      flex-wrap: wrap; flex-direction: row; z-index: 2; }
    @media (max-width: 700px) { .hud > * { margin: 2px auto; } .hud .timer { margin: 0 auto; }
      .hud .pause-btn, .hud .music-btn { font-size: 1.3em; } }
    .hud .doomguy { font-size: 2.2rem; filter: drop-shadow(0 0 10px #f00a); margin-right: 6px; }
    .hud .streak { font-weight: bold; color: #43e97b; font-size: 1.3em; margin-left: 8px; }
    .hud .timer { color: #fff; background: #252525; border-radius: 7px; box-shadow: 0 0 7px #f00a; padding: 4px 18px;
      font-size: 1.3em; display: flex; align-items: center; gap: 6px; margin: 0 7px; }
    .hud .pause-btn, .hud .music-btn { background: none; border: none; color: #43e97b; font-size: 1.5em; margin-left: 7px;
      cursor: pointer; transition: color 0.2s, transform 0.2s; }
    .hud .pause-btn:hover, .hud .music-btn:hover { color: #fff; transform: scale(1.1); }
    .hud .century-select { background: #43e97b; color: #222; border-radius: 9px; border: none; padding: 4px 8px;
      margin-left: 5px; font-size: 1em; font-family: inherit; font-weight: bold; outline: none;
      box-shadow: 0 2px 8px #0006; cursor: pointer; }
    .sidebar-nav { position: fixed; top: 70px; left: 20px; z-index: 150; display: flex; flex-direction: column; gap: 18px;
      background: rgba(17,17,17,0.85); border-radius: 18px; padding: 18px 10px; box-shadow: 0 5px 24px #000b, 0 0 2px #43e97b66;
      align-items: center; transition: left .18s; }
    .sidebar-nav button { background: #ff3333; color: #fff; border: 2px solid #222; padding: 0.6rem 1.6rem; border-radius: 14px;
      font-size: 0.95rem; letter-spacing: 1.1px; font-family: inherit; cursor: pointer; box-shadow: 0 3px 10px #0008;
      transition: background 0.17s, transform 0.13s; font-weight: bold; outline: none; width: 130px; margin: 0;
      text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.4em; }
    .sidebar-nav button:hover { background: #ff6666; transform: scale(1.07); }
    .sidebar-nav .sidebar-label { font-size: 1.07em; color: #43e97b; margin-bottom: 3px; text-shadow: 0 2px 8px #000a;
      font-weight: 800; letter-spacing: 1.2px; pointer-events: none; }
    .sidebar-toggle { display: none; position: fixed; bottom: 70px; left: 10px; z-index: 999; font-size: 1.6rem;
      padding: 6px 12px; background: #ff3333; border: none; border-radius: 10px; color: white; font-weight: bold;
      box-shadow: 0 0 10px #000a; cursor: pointer; }
    @media (max-width: 600px) {
      .sidebar-toggle { display: block; }
      .sidebar-nav.collapsed { transform: translateY(100%); opacity: 0; pointer-events: none; }
      .sidebar-nav { transition: transform .3s ease, opacity .3s ease; }
      .sidebar-nav { transform: translateY(100%); opacity: 0; pointer-events: none; }
      .sidebar-nav:not(.collapsed) { transform: translateY(0); opacity: 1; pointer-events: auto; }
    }
    @media (max-width: 800px) {
      .sidebar-nav { left: 3px; padding: 9px 4px; }
      .sidebar-nav button { width: 98px; font-size: 1em; padding: 0.48rem 0.6rem; }
    }
    @media (max-width: 600px) {
      .sidebar-nav { flex-direction: row; bottom: 0; left: 0; top: unset; width: 100vw; justify-content: center;
        background: rgba(17,17,17,0.92); border-radius: 0; box-shadow: 0 -3px 18px #000b, 0 0 2px #43e97b66; padding: 8px 0 10px 0; }
      .sidebar-nav .sidebar-label { display: none; }
      .sidebar-nav button { width: 33vw; min-width: 90px; max-width: 160px; font-size: 1.07em; }
    }
    .main-container { flex: 1; width: 100vw; max-width: 480px; display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start; padding: 28px 0 0 0; z-index: 2; position: relative;}
    h1 { margin: 0 0 20px 0; font-size: 2.1rem; letter-spacing: 2.5px; text-shadow: 0 0 12px #43e97b99, 0 2px 8px #f00a;
      font-weight: 900; text-align: center; user-select: none; font-family: 'Orbitron', 'Courier New', Courier, monospace; }
    #questionDisplay { font-size: 1.6rem; background: #222; color: #43e97b; border: 2.5px solid #ff3333; border-radius: 18px;
      box-shadow: 0 0 20px #ff333355, 0 0 2px #fff; padding: 20px 34px; margin: 18px 0 24px 0; text-align: center;
      font-weight: 700; letter-spacing: 2px; user-select: none; transition: background 0.25s; }
    .btn-container { display: flex; gap: 1rem; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
    .btn-container button { position: relative; background: radial-gradient(circle at 60% 40%, #43e97b 70%, #3bc36b 100%);
      border: 4px solid #ff3333; color: #222; border-radius: 20%; width: 120px; height: 92px; font-size: 1rem; font-family: inherit;
      font-weight: 800; letter-spacing: 1.2px; margin: 13px 7px; cursor: pointer; box-shadow: 0 4px 16px #0009, 0 0 1px #fff;
      outline: none; transition: background 0.14s, box-shadow 0.16s, transform 0.13s; z-index: 3; overflow: hidden;
      display: flex; align-items: center; justify-content: center; user-select: none; }
    .btn-container button .fragments { pointer-events: none; position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 11; }
    .emoji-burst { pointer-events: none; position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 12; overflow: visible;}
    .emoji-burst-emoji {
      position: absolute;
      left: 50%;
      top: 50%;
      font-size: 2em;
      pointer-events: none;
      opacity: 0.95;
      animation: emoji-burst-pop 1.1s cubic-bezier(.6,1.6,.4,1) forwards;
      will-change: transform, opacity;
      filter: drop-shadow(0 1px 8px #fff8);
      user-select: none;
    }
    @keyframes emoji-burst-pop {
      0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(0.7) rotate(0deg);
      }
      70% {
        opacity: 1;
        transform: translate(var(--burst-x, 0px), var(--burst-y, 0px)) scale(1.18) rotate(var(--burst-rot, 0deg));
      }
      100% {
        opacity: 0;
        transform: translate(var(--burst-x, 0px), var(--burst-y, 0px)) scale(0.95) rotate(var(--burst-rot, 0deg));
      }
    }
    .fragment { position: absolute; bottom: 45%; left: 50%; width: 22px; height: 22px; border-radius: 7px;
      background: linear-gradient(135deg, #ff3333 60%, #222 100%); opacity: 0.96; pointer-events: none; z-index: 12;
      transform: translate(-50%,0) scale(1.45) rotate(0deg); animation: fragment-fall 1.2s cubic-bezier(.61,1.7,.43,.99) forwards;
      box-shadow: 0 0 12px #fff8, 0 0 3px #43e97b88; }
    .fragment.green { background: linear-gradient(135deg, #43e97b 55%, #3bc36b 100%); box-shadow: 0 0 15px #43e97bb7, 0 0 1px #fff;
      opacity: 0.98; }
    @keyframes fragment-fall {
      0% { opacity: 1; transform: translate(-50%, 0) scale(1.45) rotate(0deg);}
      70% { opacity: 1;}
      85% { opacity: 0.9;}
      100% { opacity: 0; transform: translate(calc(-50% + var(--frag-x, 0px)), calc(250px + var(--frag-y, 0px)))
        scale(0.85) rotate(var(--frag-rot, 20deg)); }
    }
    .btn-container button:hover { background: #80ffb4; transform: scale(1.10); box-shadow: 0 6px 22px #43e97baa, 0 0 4px #fff; }
    .btn-container button.clicked { background: #f00; color: #fff; animation: recoil 0.18s cubic-bezier(.78,-0.07,0,1.43);}
    @keyframes recoil { 0% {transform: scale(1);} 40% {transform: scale(0.95);} 100% {transform: scale(1);} }
    .btn-container button.correct { background: linear-gradient(145deg,#43e97b 70%, #3bc36b 120%); color: #fff;
      border: 4px solid #ffda00; box-shadow: 0 0 15px #43e97baa, 0 0 4px #fff; animation: wrongshake 0.19s; }
    .btn-container button.wrong { background: #f00 !important; border: 4px solid #900; color: #fff; animation: wrongshake 0.19s; }
    @keyframes wrongshake { 0%,100%{transform:translate(0,0);} 30%{transform:translate(-8px,2px);}
      60%{transform:translate(6px,-4px);} }
    @media (max-width: 600px) { .main-container {padding: 10px 0;} h1 {font-size: 1.1rem;}
      #questionDisplay {font-size: 1.1rem; padding: 12px 8px;}
      .btn-container button { font-size: 1rem; width: 140px; height: 50px; }
      .hud .doomguy {font-size: 1.1rem;} }
    #levelDisplay, #levelUpCounter, #levelUpMessage, #streakMessage { font-size: 1.3rem; margin: 6px 0; text-align: center; width: 100%; }
    #levelUpMessage, #streakMessage { font-weight: bold; color: gold; animation: glow 1s ease-in-out infinite alternate;
      margin-top: 10px; display: none; }
    @keyframes glow {
      from { text-shadow: 0 0 10px gold, 0 0 20px gold; }
      to   { text-shadow: 0 0 20px orange, 0 0 30px red; }
    }
    #fireworksContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    .firework { position: absolute; width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, gold 0%, transparent 70%);
      pointer-events: none; animation: fireworks 1s ease-out; }
    @keyframes fireworks { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; }
      100% { transform: scale(0); opacity: 0; } }
    #startOverBtn, #pauseBtn { margin-top: 1rem; padding: 1rem 2rem; background-color: #43e97b; border-radius: 10px;
      font-size: 1.5rem; color: #222; cursor: pointer; border: 2px solid #ff3333; font-family: inherit; font-weight: bold;
      box-shadow: 0 3px 12px #0007; transition: background 0.2s, transform 0.09s; outline: none; }
    #startOverBtn:hover, #pauseBtn:hover { background: #ff6666; color: #fff; transform: scale(1.06); }
    .shake { animation: screenShake 0.23s 1; }
    @keyframes screenShake { 0%, 100% { transform: translate(0, 0);}
      20% { transform: translate(-10px, 3px) rotate(-2.5deg);}
      40% { transform: translate(7px, -8px) rotate(3deg);}
      60% { transform: translate(-5px, 2px) rotate(-2deg);}
      80% { transform: translate(5px, 0px) rotate(1.5deg);}
    }
    /* --- VOICE UI --- */
    .voice-ui{
      margin: 8px 0 0 0;
      background: #171a17;
      border: 2px solid #43e97b;
      border-radius: 14px;
      padding: 10px 14px;
      width: min(480px, 92vw);
      box-shadow: 0 4px 16px #0008, 0 0 2px #fff2;
    }
    #voiceStatus{
      color:#baffd1;
      font-weight:700;
      letter-spacing: .5px;
      text-shadow: 0 1px 6px #000a, 0 0 2px #43e97b;
    }
    #voiceRoundTimer{
      margin-top: 6px;
      font-weight: 800;
      color: #ffda00;
      text-shadow: 0 0 6px #000, 0 0 2px #fff;
    }
  </style>
</head>
<body>
  <canvas id="matrix-bg"></canvas>
  <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
  <nav class="sidebar-nav collapsed" aria-label="Quick external links">
    <span class="sidebar-label">Links</span>
    <button onclick="window.location.href='index.html'" title="Cal">üìÖ Cal</button>
    <button onclick="window.location.href='Exponential.html'" title="Expo">üî¢ Expo</button>
    <button onclick="window.location.href='https://shop.thenoeticexperience.com/'" title="Book">üìñ Book</button>
    <button onclick="window.location.href='Division.html'" title="Div">‚ûó Div</button>
    <button onclick="window.location.href='Donation.html'" class="active" title="Donate">ü™ô Donate</button>
  </nav>
  <div class="hud">
    <span class="doomguy" id="doomguy-face">üòÄ</span>
    <span id="streakDisplay" class="streak">üî• Streak: 0</span>
    <span class="timer" id="timerDisplay">‚è±Ô∏è 0:30</span>
    <button class="pause-btn" onclick="togglePause()" id="hudPauseBtn" aria-label="Pause or resume timer">‚è∏</button>
    <button class="music-btn" id="musicPauseBtn" onclick="toggleMusic()" aria-label="Pause or play music">üéµ‚ñ∂Ô∏è</button>
    <select id="musicSelect" class="century-select" aria-label="Choose background music">
      <option value="doom">DOOM</option>
      <option value="lofi">Beethoven</option>
      <option value="cyberpunk">Nitro</option>
      <option value="relax">Relax</option>
      <option value="think">Think</option>
    </select>
    <select id="multLevelSelect" class="century-select" aria-label="Choose multiplication level">
      <option value="1x2">1x2 digits</option>
      <option value="1x3">1x3 digits</option>
      <option value="2x2">2x2 digits</option>
    </select>
  </div>
  <div class="main-container">
    <h1>‚úñÔ∏è ùïÆùñÜùñë¬≤ Multiplication Trainer</h1>
    <div id="questionDisplay"></div>
    <div class="btn-container" id="answerButtons"></div>
    <div id="levelDisplay">üèÜ Level: 1</div>
    <div id="levelUpCounter"></div>
    <div id="levelUpMessage"></div>
    <div id="streakMessage"></div>
    <button id="startOverBtn" onclick="startGame()">‚ñ∂Ô∏è Start Game</button>
    <button id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
    <!-- === VOICE MODE BUTTON AND UI === -->
    <div class="btn-container">
      <button id="voiceModeBtn" title="Speak & Answer by Voice">üéôÔ∏è Voice Mode</button>
    </div>
    <div id="voiceUI" class="voice-ui" aria-live="polite" style="display:none;">
      <div id="voiceStatus">üéß Voice idle. Click ‚ÄúVoice Mode‚Äù to start.</div>
      <div id="voiceRoundTimer">‚è±Ô∏è Reaction: 0.0 s</div>
    </div>
    <div id="fireworksContainer"></div>
  </div>

  <!-- Sounds: Use friendly SFX from your calendar version -->
  <audio id="correctSound" src="https://www.myinstants.com/media/sounds/correct-pinpon.mp3"></audio>
  <audio id="wrongSound" src="https://www.myinstants.com/media/sounds/answer-wrong.mp3"></audio>
  <audio id="levelUpSound" src="https://www.myinstants.com/media/sounds/crowdhomerunapplause.wav"></audio>
  <audio id="gameOverSound" src="https://www.myinstants.com/media/sounds/ocarina-of-time-73-game-over.mp3"></audio>
  <audio id="doomMusic" src="https://www.myinstants.com/media/sounds/doom-ost-e1m1-at-dooms-gatedodoc.mp3" loop></audio>
  <audio id="lofiMusic" src="assets/bet1.mp3" loop></audio>
  <audio id="cyberpunkMusic" src="assets/nitro.mp3" loop></audio>
  <audio id="relaxMusic" src="https://www.bensound.com/bensound-music/bensound-slowmotion.mp3" loop></audio>
  <audio id="thinkMusic" src="https://www.bensound.com/bensound-music/bensound-scifi.mp3" loop></audio>
  <script>
    // === GLOBAL GAME STATE ===
    let timerInterval;
    let currentAnswer;
    let streakCount = 0;
    let isGameOver = false;
    let isPaused = false;
    let totalCorrect = 0;
    let timeLeft = 30;
    let level = 1;
    let levelUpCounter = 25;
    let multLevel = "1x2";

    // --- DOOMGUY FACE LOGIC ---
    const doomGuyFaces = ["üòÄ", "üòê", "üò¨", "üòµ"];
    function updateDoomguyFace() {
      let idx = 0;
      if (isGameOver) idx = 3;
      else if (timeLeft < 12) idx = 2;
      else if (timeLeft < 30) idx = 1;
      else idx = 0;
      document.getElementById('doomguy-face').textContent = doomGuyFaces[idx];
    }

    // --- MUSIC STATE ---
    const musicTracks = {
      doom: document.getElementById('doomMusic'),
      lofi: document.getElementById('lofiMusic'),
      cyberpunk: document.getElementById('cyberpunkMusic'),
      relax: document.getElementById('relaxMusic'),
      think: document.getElementById('thinkMusic'),
    };
    let currentMusic = 'doom';

    const musicPauseBtn = document.getElementById('musicPauseBtn');
    const musicSelect = document.getElementById('musicSelect');

    function playMusic(track) {
      Object.values(musicTracks).forEach(m => {
        m.pause();
        m.currentTime = 0;
      });
      musicTracks[track].play();
      musicPauseBtn.innerHTML = 'üéµ‚è∏';
      musicPauseBtn.setAttribute('aria-label', 'Pause music');
    }

    function showCorrectOverlay() {
      let overlay = document.createElement('div');
      overlay.textContent = '‚úÖ Correct!';
      overlay.style.position = 'fixed';
      overlay.style.top = '50%';
      overlay.style.left = '50%';
      overlay.style.transform = 'translate(-50%,-50%) scale(1)';
      overlay.style.background = 'rgba(40,210,90,0.97)';
      overlay.style.color = '#fff';
      overlay.style.fontSize = '2.3em';
      overlay.style.fontWeight = 'bold';
      overlay.style.padding = '30px 44px';
      overlay.style.borderRadius = '22px';
      overlay.style.boxShadow = '0 0 30px #43e97baa, 0 0 8px #fff';
      overlay.style.zIndex = 9999;
      overlay.style.textAlign = 'center';
      overlay.style.pointerEvents = 'none';
      overlay.style.opacity = 1;
      overlay.style.transition = 'opacity 0.7s';
      document.body.appendChild(overlay);
      setTimeout(() => overlay.style.opacity = 0, 500);
      setTimeout(() => { if(overlay.parentNode) overlay.parentNode.removeChild(overlay); }, 1300);
    }

    function pauseMusic(track) {
      musicTracks[track].pause();
      musicPauseBtn.innerHTML = 'üéµ‚ñ∂Ô∏è';
      musicPauseBtn.setAttribute('aria-label', 'Play music');
    }
    function isMusicPaused(track) {
      return musicTracks[track].paused;
    }
    function toggleMusic() {
      if (isMusicPaused(currentMusic)) {
        musicTracks[currentMusic].play();
        musicPauseBtn.innerHTML = 'üéµ‚è∏';
        musicPauseBtn.setAttribute('aria-label', 'Pause music');
      } else {
        musicTracks[currentMusic].pause();
        musicPauseBtn.innerHTML = 'üéµ‚ñ∂Ô∏è';
        musicPauseBtn.setAttribute('aria-label', 'Play music');
      }
    }
    musicSelect.addEventListener('change', function () {
      currentMusic = this.value;
      playMusic(currentMusic);
    });

    document.addEventListener('DOMContentLoaded', function() {
      Object.values(musicTracks).forEach(m => { m.pause(); m.currentTime = 0; });
      musicPauseBtn.innerHTML = 'üéµ‚ñ∂Ô∏è';
      musicPauseBtn.setAttribute('aria-label', 'Play music');
      if(window.innerWidth <= 600) {
        document.querySelector('.sidebar-nav').classList.add('collapsed');
      } else {
        document.querySelector('.sidebar-nav').classList.remove('collapsed');
      }
    });
    window.addEventListener('beforeunload', () => {
      Object.values(musicTracks).forEach(m => m.pause());
    });
    function toggleSidebar() {
      document.querySelector('.sidebar-nav').classList.toggle('collapsed');
    }

    // --- LEVEL DROPDOWN HANDLING ---
    const multLevelSelect = document.getElementById('multLevelSelect');
    multLevelSelect.addEventListener('change', function() {
      multLevel = this.value;
      level = 1;
      startGame();
    });
    multLevel = multLevelSelect.value;

    // --- MULTIPLICATION GAME LOGIC ---
    function startGame() {
      streakCount = 0;
      totalCorrect = 0;
      isGameOver = false;
      level = 1;
      levelUpCounter = 25;
      if (multLevel === "1x2") timeLeft = 30;
      else if (multLevel === "1x3") timeLeft = 35;
      else timeLeft = 40;
      document.getElementById('startOverBtn').style.display = 'none';
      document.getElementById('levelUpMessage').style.display = 'none';
      document.getElementById('streakMessage').style.display = 'none';
      updateDisplays();
      generateQuestion();
      startTimer();
      updateDoomguyFace();
    }

    function togglePause() {
      isPaused = !isPaused;
      document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
      document.getElementById('hudPauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è' : '‚è∏';
      if (!isPaused && !isGameOver) startTimer();
    }

    function updateDisplays() {
      document.getElementById('streakDisplay').textContent = `üî• Streak: ${streakCount}`;
      document.getElementById('timerDisplay').textContent = `‚è±Ô∏è 0:${timeLeft < 10 ? '0' + timeLeft : timeLeft}`;
      document.getElementById('levelDisplay').textContent = `üèÜ Level: ${level}`;
      updateDoomguyFace();
    }

    function startTimer() {
      clearInterval(timerInterval);
      updateDoomguyFace();
      timerInterval = setInterval(() => {
        if (!isPaused && !isGameOver) {
          timeLeft--;
          updateDisplays();
          if (timeLeft <= 0) gameOver('‚è∞ Time Up!');
        }
      }, 1000);
    }

    function resetTimer() {
      clearInterval(timerInterval);
      if (multLevel === "1x2") timeLeft = 30;
      else if (multLevel === "1x3") timeLeft = 35;
      else timeLeft = 40;
      updateDisplays();
      startTimer();
    }

    function generateQuestion() {
      if (isGameOver) return;
      let num1, num2, displayText, possibleAnswers;
      if (multLevel === "1x2") {
        num1 = Math.floor(Math.random() * 9) + 1;
        num2 = Math.floor(Math.random() * 90) + 10;
      } else if (multLevel === "1x3") {
        num1 = Math.floor(Math.random() * 9) + 1;
        num2 = Math.floor(Math.random() * 900) + 100;
      } else if (multLevel === "2x2") {
        num1 = Math.floor(Math.random() * 90) + 10;
        num2 = Math.floor(Math.random() * 90) + 10;
      }
      displayText = `What is ${num1} √ó ${num2}?`;
      currentAnswer = num1 * num2;

      // ---- New distractor logic ----
      const correct = currentAnswer;
      const lastDigit = correct % 10;
      possibleAnswers = [correct];
      const used = new Set([correct]);
      let offsets = [-30, -20, -10, 10, 20, 30, -40, 40, -50, 50];
      let candidates = [];
      offsets.forEach(offset => {
        let guess = correct + offset;
        if (
          guess > 0 &&
          guess % 10 === lastDigit &&
          !used.has(guess)
        ) {
          candidates.push(guess);
          used.add(guess);
        }
      });
      while (candidates.length < 6) {
        let delta = (Math.floor(Math.random() * 7) - 3) * 10;
        let guess = correct + delta;
        if (
          guess > 0 &&
          guess % 10 === lastDigit &&
          !used.has(guess)
        ) {
          candidates.push(guess);
          used.add(guess);
        }
        if (candidates.length >= 6) break;
      }
      shuffle(candidates);
      while (possibleAnswers.length < 4 && candidates.length > 0) {
        possibleAnswers.push(candidates.pop());
      }
      let base = correct + 10;
      while (possibleAnswers.length < 4) {
        if (
          base % 10 === lastDigit &&
          !used.has(base)
        ) {
          possibleAnswers.push(base);
          used.add(base);
        }
        base += 10;
      }
      possibleAnswers = shuffle(possibleAnswers);

      // Render UI
      document.getElementById('questionDisplay').textContent = displayText;
      const buttons = document.getElementById('answerButtons');
      buttons.innerHTML = '';
      possibleAnswers.forEach(answer => {
        const btn = document.createElement('button');
        btn.textContent = answer;
        const fragSpan = document.createElement('span');
        fragSpan.className = 'fragments';
        btn.appendChild(fragSpan);

        // Add emoji burst container
        const emojiBurst = document.createElement('span');
        emojiBurst.className = 'emoji-burst';
        btn.appendChild(emojiBurst);

        btn.onclick = () => {
          handleAnswerClick(answer, btn);
        };
        buttons.appendChild(btn);
      });
    }

    // Emoji burst like Calendar Trainer
    function spawnEmojiBurstAtButton(button) {
      const rect = button.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2 + window.scrollX;
      const centerY = rect.top + rect.height / 2 + window.scrollY;

      const burst = document.createElement('span');
      burst.className = 'emoji-burst';
      burst.style.position = 'absolute';
      burst.style.left = (centerX) + 'px';
      burst.style.top = (centerY) + 'px';
      burst.style.pointerEvents = 'none';
      burst.style.zIndex = 1000;
      burst.style.width = 0;
      burst.style.height = 0;

      const emojis = ['üéâ','üåü','‚ú®','ü•≥','üéä','ü¶Ñ','üòÑ','üí´','üéà','ü§©','üöÄ','üçÄ'];
      const count = 13 + Math.floor(Math.random() * 6);
      for (let i = 0; i < count; i++) {
        const e = document.createElement('span');
        e.className = 'emoji-burst-emoji';
        e.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        const angle = Math.random() * 2 * Math.PI;
        const radius = 60 + Math.random() * 55;
        const x = Math.cos(angle) * radius + (Math.random()-0.5)*30;
        const y = Math.sin(angle) * radius * 0.8 + (Math.random()-0.5)*15;
        const rot = -60 + Math.random()*120;
        e.style.setProperty('--burst-x', `${x.toFixed(1)}px`);
        e.style.setProperty('--burst-y', `${y.toFixed(1)}px`);
        e.style.setProperty('--burst-rot', `${rot.toFixed(1)}deg`);
        burst.appendChild(e);
      }
      document.body.appendChild(burst);

      setTimeout(() => {
        if (burst && burst.parentNode) burst.parentNode.removeChild(burst);
      }, 1600);
    }

    function playCorrectSound() {
      const s = document.getElementById('correctSound');
      if (s) { s.currentTime = 0; s.play(); }
    }
    function playWrongSound() {
      const s = document.getElementById('wrongSound');
      if (s) { s.currentTime = 0; s.play(); }
    }

    function handleAnswerClick(answer, button) {
      if (isGameOver || isPaused) return;
      const allBtns = document.querySelectorAll('#answerButtons button');
      allBtns.forEach(btn => btn.disabled = true);

      if (answer === currentAnswer) {
        streakCount++;
        totalCorrect++;
        if (totalCorrect % 10 === 0) {
          playSound('levelUpSound');
          showStreakMessage();
        }
        button.classList.add('correct');
        showCorrectOverlay();
        playCorrectSound();
        resetTimer();
        setTimeout(generateQuestion, 800);
        levelUpCheck();
        document.body.classList.remove('shake');
        void document.body.offsetWidth;
        document.body.classList.add('shake');
      } else {
        button.classList.add('wrong');
        playWrongSound();
        document.body.classList.remove('shake');
        void document.body.offsetWidth;
        document.body.classList.add('shake');
        setTimeout(() => gameOver('‚ùå Wrong Answer!'), 400);
      }
      button.classList.add('clicked');
      updateDisplays();
    }

    function playSound(id) {
      const sound = document.getElementById(id);
      if (sound) {
        sound.currentTime = 0;
        sound.play();
      }
    }
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    function levelUpCheck() {
      if (totalCorrect >= levelUpCounter) {
        level++;
        levelUpCounter *= 4;
        playSound('levelUpSound');
        triggerFireworks();
        const msg = document.getElementById('levelUpMessage');
        msg.textContent = `üéâ Level ${level} Achieved!`;
        msg.style.display = 'block';
        setTimeout(() => { msg.style.display = 'none'; }, 4000);
        updateDisplays();
      }
    }
    function showStreakMessage() {
      const msg = document.getElementById('streakMessage');
      msg.textContent = "üî• You're on fire!";
      msg.style.display = 'block';
      setTimeout(() => { msg.style.display = 'none'; }, 3000);
    }
    function gameOver(message) {
      isGameOver = true;
      clearInterval(timerInterval);
      if (totalCorrect >= 100) triggerFireworks();
      document.getElementById('startOverBtn').style.display = 'inline';
      alert(message);
      playSound('gameOverSound');
      updateDoomguyFace();
    }
    function triggerFireworks(x = window.innerWidth / 2, y = window.innerHeight / 2) {
      const container = document.getElementById('fireworksContainer');
      for (let i = 0; i < 10; i++) {
        const firework = document.createElement('div');
        firework.classList.add('firework');
        firework.style.left = `${x + Math.random() * 200 - 100}px`;
        firework.style.top = `${y + Math.random() * 200 - 100}px`;
        container.appendChild(firework);
        setTimeout(() => container.removeChild(firework), 1000);
      }
    }

    // =======================================================
    // === VOICE MODE for Multiplication Trainer (NEW!) ======
    // =======================================================
    let voiceRoundActive = false;
    let voiceModeShouldLoop = false;
    let recognition = null;
    let reactionTimerInterval = null;
    let voiceTimerStart = null;
    let reactionTimerRunning = false;

    const voiceUI = document.getElementById('voiceUI');
    const voiceStatus = document.getElementById('voiceStatus');
    const voiceRoundTimer = document.getElementById('voiceRoundTimer');
    const voiceBtn = document.getElementById('voiceModeBtn');

    function wordsToNumber(words) {
      // Simple parser for English numbers up to 9999, can be extended!
      const small = {
        zero:0, one:1, two:2, three:3, four:4, five:5, six:6, seven:7, eight:8, nine:9,
        ten:10, eleven:11, twelve:12, thirteen:13, fourteen:14, fifteen:15, sixteen:16,
        seventeen:17, eighteen:18, nineteen:19
      };
      const tens = {
        twenty:20, thirty:30, forty:40, fifty:50, sixty:60, seventy:70, eighty:80, ninety:90
      };
      let tokens = words.toLowerCase().replace(/[^a-z\s\d]/g,'').split(/\s+/);
      let n = 0, current = 0;
      for(let w of tokens) {
        if(small[w] != null) current += small[w];
        else if(tens[w]) current += tens[w];
        else if(w === "hundred") current *= 100;
        else if(w === "thousand") { n += current * 1000; current = 0; }
        else if(Number(w)) current += Number(w);
      }
      return n + current;
    }


    function showVoiceUI(show) {
      voiceUI.style.display = show ? '' : 'none';
      if (!show) {
        voiceStatus.textContent = '';
        voiceRoundTimer.textContent = '';
      } else {
        // Add stop button if not present
        if (!document.getElementById('stopVoiceBtn')) {
          const stopBtn = document.createElement('button');
          stopBtn.id = "stopVoiceBtn";
          stopBtn.textContent = "üõë Stop Voice Mode";
          stopBtn.style = "margin-top:10px;background:#900;color:white;border-radius:9px;padding:6px 24px;font-weight:bold;box-shadow:0 0 7px #f00b;";
          stopBtn.onclick = stopVoiceMode;
          voiceUI.appendChild(stopBtn);
        }
      }
    }
    function setVoiceStatus(msg, mode='info') {
      if (!voiceStatus) return;
      voiceStatus.textContent = msg;
      const colors = {
        info: '#baffd1', speaking: '#80ffb4', listening: '#ffda00',
        hearing:'#ffda00', warn:'#ffb366', error:'#ff8080'
      };
      voiceStatus.style.color = colors[mode] || '#baffd1';
    }
    function startReactionTimer({ reset = false } = {}) {
      if (reactionTimerRunning && !reset) return;
      if (reactionTimerInterval) clearInterval(reactionTimerInterval);
      if (reset || !reactionTimerRunning) {
        voiceTimerStart = performance.now();
        updateVoiceTimer(0);
      }
      reactionTimerInterval = setInterval(() => {
        const t = (performance.now() - voiceTimerStart) / 1000;
        updateVoiceTimer(t);
      }, 50);
      reactionTimerRunning = true;
    }
    function stopReactionTimer() {
      if (reactionTimerInterval) {
        clearInterval(reactionTimerInterval);
        reactionTimerInterval = null;
      }
      reactionTimerRunning = false;
    }
    function updateVoiceTimer(seconds) {
      if (voiceRoundTimer)
        voiceRoundTimer.textContent = `‚è±Ô∏è Reaction: ${Math.max(0, seconds).toFixed(1)} s`;
    }

    // Pick a good TTS voice
    let loadedVoices = [];
    function loadVoices() {
      loadedVoices = window.speechSynthesis ? (window.speechSynthesis.getVoices() || []) : [];
    }
    if ('speechSynthesis' in window) {
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }
    function pickExpressiveVoice() {
      const preferred = [
        /Google US English/i,
        /Google UK English Female/i,
        /Samantha/i,
        /Victoria/i
      ];
      for (const rx of preferred) {
        const v = loadedVoices.find(v => rx.test(v.name));
        if (v) return v;
      }
      const anyEN = loadedVoices.find(v => /en(-|_)?/i.test(v.lang));
      return anyEN || loadedVoices[0] || null;
    }

    // Speak out the multiplication question
    function speakMultiplicationQuestion(num1, num2) {
      return new Promise((resolve, reject) => {
        if (!('speechSynthesis' in window)) {
          setVoiceStatus('‚ùå Your browser does not support TTS.', 'error');
          return reject();
        }
        const hype = ["Okay, listen up.", "Next one.", "Heads up.", "Let's roll.", "Try this one."][Math.floor(Math.random()*5)];
        const phrase = `${hype} What is ${num1} times ${num2}?`;
        const u = new SpeechSynthesisUtterance(phrase);
        const v = pickExpressiveVoice();
        if (v) u.voice = v;
        u.rate = 1.03;
        u.pitch = 1.12;
        u.onstart = () => setVoiceStatus(`üó£Ô∏è Speaking: ‚Äú${num1} √ó ${num2}‚Äù ‚Ä¶`, 'speaking');
        u.onerror = (e) => { setVoiceStatus('‚ùå TTS error.', 'error'); reject(); };
        u.onend = () => { resolve(); };
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      });
    }

    function extractNumberFromText(text) {
      // Try direct digits
      let num = parseInt(text.replace(/[^\d]/g, ''));
      if (!isNaN(num) && num !== 0) return num;
      // Try parsing as words
      let parsed = wordsToNumber(text);
      if (!isNaN(parsed) && parsed !== 0) return parsed;
      return null;
    }
    
    function announceMultiplicationOutcome(correct, heard, seconds = null) {
      return new Promise((resolve) => {
        if (!('speechSynthesis' in window)) return resolve();
        const s = seconds != null ? seconds.toFixed(2) : null;
        let line;
        if (correct) {
          const praise = ["Nice!", "Correct!", "Good job!", "Sharp!", "You got it!"];
          line = `${praise[Math.floor(Math.random() * praise.length)]} ${s ? `You answered in ${s} seconds.` : ''}`;
        } else {
          line = `Sorry, that's not correct. The answer was ${currentAnswer}. ${s ? `You answered in ${s} seconds.` : ''}`;
        }
        const u = new SpeechSynthesisUtterance(line);
        const v = pickExpressiveVoice();
        if (v) u.voice = v;
        u.rate = correct ? 1.06 : 1.0;
        u.pitch = correct ? 1.15 : 1.0;
        u.onend = () => resolve();
        u.onerror = () => resolve();
        try { window.speechSynthesis.speak(u); } catch (_) { resolve(); }
      });
    }

    function ensureMicPermissionOnce() {
      // On Chrome, getUserMedia is not required, but we can check for permissions API
      return Promise.resolve(true);
    }

    async function startVoiceMultiplicationRound(loop = true) {
      isPaused = false;
      isGameOver = false;
      clearInterval(timerInterval);
      if (multLevel === "1x2") timeLeft = 30;
      else if (multLevel === "1x3") timeLeft = 35;
      else timeLeft = 40;
      updateDisplays();

      if (voiceRoundActive) return;
      voiceRoundActive = true;
      voiceModeShouldLoop = loop;

      showVoiceUI(true);
      setVoiceStatus('üéß Preparing voice...', 'info');

      try { await ensureMicPermissionOnce(); } catch {
        setVoiceStatus('‚ùå Microphone not available or permission denied.', 'error');
        voiceRoundActive = false; voiceModeShouldLoop = false;
        return;
      }

      // Generate a question
      let num1, num2;
      if (multLevel === "1x2") {
        num1 = Math.floor(Math.random() * 9) + 1;
        num2 = Math.floor(Math.random() * 90) + 10;
      } else if (multLevel === "1x3") {
        num1 = Math.floor(Math.random() * 9) + 1;
        num2 = Math.floor(Math.random() * 900) + 100;
      } else if (multLevel === "2x2") {
        num1 = Math.floor(Math.random() * 90) + 10;
        num2 = Math.floor(Math.random() * 90) + 10;
      }
      currentAnswer = num1 * num2;
      document.getElementById('questionDisplay').textContent = `What is ${num1} √ó ${num2}?`;
      document.getElementById('answerButtons').innerHTML = ''; // Hide normal buttons

      // Read out the question
      await speakMultiplicationQuestion(num1, num2);

      // Listen for spoken answer
      await listenForNumberAnswer(num1, num2, loop);
    }

    function listenForNumberAnswer(num1, num2, loop) {
      return new Promise((resolve, reject) => {
        const ASR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!ASR) {
          setVoiceStatus('‚ùå Speech recognition not supported in this browser. Try Chrome desktop.', 'error');
          return reject();
        }
        try { if (recognition) recognition.abort(); } catch(_) {}

        const MIN_CHARS = 1;
        const INACTIVITY_MS = 12000;
        const MAX_RESTARTS = 2;

        let restarts = 0;
        let inactivityTimer = null;

        const resetInactivity = () => {
          if (inactivityTimer) clearTimeout(inactivityTimer);
          inactivityTimer = setTimeout(() => softRestart('timeout'), INACTIVITY_MS);
        };

        const softRestart = (reason) => {
          if (heardNumber !== null) return;
          if (inactivityTimer) { clearTimeout(inactivityTimer); inactivityTimer = null; }
          if (restarts < MAX_RESTARTS) {
            restarts++;
            setVoiceStatus('üîá Silence‚Ä¶ still listening.', 'warn');
            setTimeout(() => {
              try { recognition && recognition.abort(); } catch(_) {}
              startOnce();
            }, 250);
          } else {
            stopReactionTimer();
            voiceRoundActive = false;
            setVoiceStatus('ü§î Didn‚Äôt catch a number. Click ‚ÄúVoice Mode‚Äù and try again.', 'warn');
            resolve();
          }
        };

        let heardNumber = null;
        let lastTranscript = "";

        let recognition;

        const startOnce = () => {
          recognition = new ASR();
          recognition.lang = 'en-US';
          recognition.interimResults = true;
          recognition.maxAlternatives = 3;
          recognition.continuous = false;

          recognition.onstart = () => {
            setVoiceStatus('üé§ Listening‚Ä¶ say the answer!', 'listening');
            startReactionTimer();
            resetInactivity();
          };

          recognition.onresult = (event) => {
            resetInactivity();
            let transcript = "";
            for (let i = 0; i < event.results.length; i++) {
              transcript += (event.results[i][0] && event.results[i][0].transcript ? event.results[i][0].transcript : '') + " ";
            }
            transcript = transcript.trim();
            lastTranscript = transcript;
            if (!transcript || transcript.length < MIN_CHARS) {
              setVoiceStatus('üëÇ Heard something‚Ä¶', 'hearing');
              return;
            }
            let num = extractNumberFromText(transcript);
            if (num && !isNaN(num)) {
              heardNumber = num;
              try { recognition.stop(); } catch(_) {}
            } else {
              setVoiceStatus(`üëÇ Heard: ‚Äú${transcript}‚Äù ‚Ä¶ (say the number)`, 'hearing');
            }
          };

          recognition.onerror = (e) => {
            softRestart(e.error || 'error');
          };

          recognition.onend = async () => {
            if (heardNumber === null) {
              return softRestart('ended');
            }
            // Check answer
            const ok = (heardNumber === currentAnswer);
            handleVoiceAnswerFeedback(ok, heardNumber);
            const took = (performance.now() - voiceTimerStart) / 1000;
            stopReactionTimer();
            await announceMultiplicationOutcome(ok, heardNumber, took);
            await new Promise(r => setTimeout(r, 250));
            voiceRoundActive = false;
            if (ok && loop && voiceModeShouldLoop) startVoiceMultiplicationRound(true);
            resolve();
          };

          try { recognition.start(); }
          catch (e) {
            setVoiceStatus('‚ùå Could not start listening.', 'error');
            stopReactionTimer();
            voiceRoundActive = false;
            voiceModeShouldLoop = false;
            reject(e);
          }
        };

        startOnce();
      });
    }

    function handleVoiceAnswerFeedback(ok, heardNumber) {
      if (ok) {
        streakCount++;
        totalCorrect++;
        if (totalCorrect % 10 === 0) {
          playSound('levelUpSound');
          showStreakMessage();
        }
        showCorrectOverlay();
        playCorrectSound();
        levelUpCheck();
        document.body.classList.remove('shake');
        void document.body.offsetWidth;
        document.body.classList.add('shake');
      } else {
        playWrongSound();
        document.body.classList.remove('shake');
        void document.body.offsetWidth;
        document.body.classList.add('shake');
        setTimeout(() => gameOver('‚ùå Wrong Answer!'), 400);
      }
      updateDisplays();
    }

    function stopVoiceMode() {
      voiceModeShouldLoop = false;
      voiceRoundActive = false;
      setVoiceStatus('üõë Voice mode stopped.', 'info');
      showVoiceUI(false);
      try { if (recognition) recognition.abort(); } catch(_){}
      stopReactionTimer();
    }

    voiceBtn.onclick = () => {
      voiceModeShouldLoop = true;
      startVoiceMultiplicationRound(true);
    };



    document.getElementById('startOverBtn').style.display = 'inline';
    window.addEventListener('keydown', e => {
      if (e.code === 'Space') {
        e.preventDefault();
        togglePause();
      }
    });
  </script>
</body>
</html>